---
import { Image } from "astro:assets";

const response = await fetch("https://api-calinema.onrender.com/api/movies/");
const movies = await response.json();
---

<section class="movies__main">
    <section class="movies__cinecolombia movies__container">
        <article class="movies__texts">
            <h2 class="cinema__title">CineColombia</h2>
            <ul class="movie__list">
                <!-- Mensaje por si no hay películas -->
                <li class="noMovies__message--item" style="display: none;">
                    <h2 class="noMovies__message">
                        No hay películas disponibles
                    </h2>
                </li>

                {
                    movies.map(
                        (movie) =>
                            movie.cinema_name === "CineColombia" && (
                                <li class="movie__items">
                                    <figure class="movie__figure">
                                        <Image
                                            class="movie__img"
                                            src={movie.image_url}
                                            data-id={movie.id}
                                            data-title={movie.title}
                                            data-cinema={movie.cinema_name}
                                            alt={movie.title}
                                            width={230}
                                            height={345}
                                        />
                                    </figure>
                                    <div class="movie__texts">
                                        <h3 class="movie__title">
                                            {movie.title}
                                        </h3>
                                        <p class="movie__cinema">
                                            {movie.cinema_name}
                                        </p>
                                    </div>
                                </li>
                            ),
                    )
                }
            </ul>
        </article>
    </section>

    <section class="movies__cinepolis movies__container">
        <article class="movies__texts">
            <h2 class="cinema__title">Cinepolis</h2>
            <ul class="movie__list">
                <!-- Mensaje por si no hay películas -->
                <li class="noMovies__message--item" style="display: none;">
                    <h2 class="noMovies__message">
                        No hay películas disponibles
                    </h2>
                </li>

                {
                    movies.map(
                        (movie) =>
                            movie.cinema_name === "Cinepolis" && (
                                <li class="movie__items">
                                    <figure class="movie__figure">
                                        <Image
                                            class="movie__img"
                                            src={movie.image_url}
                                            data-id={movie.id}
                                            data-title={movie.title}
                                            data-cinema={movie.cinema_name}
                                            alt={movie.title}
                                            width={230}
                                            height={345}
                                        />
                                    </figure>
                                    <div class="movie__texts">
                                        <h3 class="movie__title">
                                            {movie.title}
                                        </h3>
                                        <p class="movie__cinema">
                                            {movie.cinema_name}
                                        </p>
                                    </div>
                                </li>
                            ),
                    )
                }
            </ul>
        </article>
    </section>

    <section class="movies__cinemark movies__container">
        <article class="movies__texts">
            <h2 class="cinema__title">Cinemark</h2>
            <ul class="movie__list">
                <!-- Mensaje por si no hay películas -->
                <li class="noMovies__message--item" style="display: none;">
                    <h2 class="noMovies__message">
                        No hay películas disponibles
                    </h2>
                </li>

                {
                    movies.map(
                        (movie) =>
                            movie.cinema_name === "Cinemark" && (
                                <li class="movie__items">
                                    <figure class="movie__figure">
                                        <Image
                                            class="movie__img"
                                            src={movie.image_url}
                                            data-id={movie.id}
                                            data-title={movie.title}
                                            data-cinema={movie.cinema_name}
                                            alt={movie.title}
                                            width={230}
                                            height={345}
                                        />
                                    </figure>
                                    <div class="movie__texts">
                                        <h3 class="movie__title">
                                            {movie.title}
                                        </h3>
                                        <p class="movie__cinema">
                                            {movie.cinema_name}
                                        </p>
                                    </div>
                                </li>
                            ),
                    )
                }
            </ul>
        </article>
    </section>

    <section class="movies__izimovie movies__container">
        <article class="movies__texts">
            <h2 class="cinema__title">IziMovie</h2>
            <ul class="movie__list">
                <!-- Mensaje por si no hay películas -->
                <li class="noMovies__message--item" style="display: none;">
                    <h2 class="noMovies__message">
                        No hay películas disponibles
                    </h2>
                </li>

                {
                    movies.map(
                        (movie) =>
                            movie.cinema_name === "IziMovie" && (
                                <li class="movie__items">
                                    <figure class="movie__figure">
                                        <Image
                                            class="movie__img"
                                            src={movie.image_url}
                                            data-id={movie.id}
                                            data-title={movie.title}
                                            data-cinema={movie.cinema_name}
                                            alt={movie.title}
                                            width={230}
                                            height={345}
                                        />
                                    </figure>
                                    <div class="movie__texts">
                                        <h3 class="movie__title">
                                            {movie.title}
                                        </h3>
                                        <p class="movie__cinema">
                                            {movie.cinema_name}
                                        </p>
                                    </div>
                                </li>
                            ),
                    )
                }
            </ul>
        </article>
    </section>

    <section class="movies__royalfilms movies__container">
        <article class="movies__texts">
            <h2 class="cinema__title">RoyalFilms</h2>
            <ul class="movie__list">
                <!-- Mensaje por si no hay películas -->
                <li class="noMovies__message--item" style="display: none;">
                    <h2 class="noMovies__message">
                        No hay películas disponibles
                    </h2>
                </li>

                {
                    movies.map(
                        (movie) =>
                            movie.cinema_name === "RoyalFilms" && (
                                <li class="movie__items">
                                    <figure class="movie__figure">
                                        <img
                                            class="movie__img"
                                            src={movie.image_url}
                                            data-id={movie.id}
                                            data-title={movie.title}
                                            data-cinema={movie.cinema_name}
                                        />
                                    </figure>
                                    <div class="movie__texts">
                                        <h3 class="movie__title">
                                            {movie.title}
                                        </h3>
                                        <p class="movie__cinema">
                                            {movie.cinema_name}
                                        </p>
                                    </div>
                                </li>
                            ),
                    )
                }
            </ul>
        </article>
    </section>
</section>

<style>
    .movies__main {
        width: 100%;
    }

    .movies__genres {
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
    }

    .movie__genres--list {
        display: flex;
        align-items: center;
        /* transition: transform 1s ease-in-out; */
        justify-content: left;
        overflow-x: hidden;
        scroll-behavior: smooth;
        padding: 0;
    }

    .arrows__container {
        width: 100%;
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 25%;
    }

    .arrow {
        background-color: transparent;
        color: #fff;
        border: none;
        font-size: 4rem;
        cursor: pointer;
    }

    .arrow:hover {
        cursor: pointer;
        font-weight: bold;
    }

    .movies__container,
    .movies__genres {
        margin: 0 auto;
        background-color: #121212;
        width: 90%;
        border-radius: 12px;
    }

    .movies__texts {
        width: 100%;
        height: 100%;
        max-width: 1600px;
        margin: 0 auto;
        overflow: hidden;
        text-align: center;
        padding-bottom: 70px;
    }

    .movies__search {
        display: none;
    }

    .cinema__title {
        font-size: 2.2rem;
        font-weight: bold;
        padding: 40px 0;
    }

    .movie__title {
        font-size: 1.8rem;
        font-weight: bold;
        padding-bottom: 10px;
    }

    .movie__cinema {
        font-size: 1.2rem;
    }

    .movie__list {
        display: grid;
        padding: 0;
        grid-template-columns: repeat(auto-fit, minmax(235px, 1fr));
        gap: 50px 0;
        list-style: none;
    }

    .movie__items {
        font-size: 1.5rem;
        display: flex;
        flex-direction: column;
        align-items: center;
        width: 230px;
        justify-self: center;
        align-self: flex-start;
    }

    .movie__texts {
        margin-top: 20px;
    }

    .movie__figure {
        height: 345px;
        width: 230px;
        transition: transform 0.2s;
    }

    .movie__figure:hover {
        transform: scale(1.02);
        cursor: pointer;
        z-index: 0;
    }

    .movie__img {
        object-fit: cover;
        width: 100%;
        height: 100%;
        border-radius: 12px;
    }

    .noMovies__message {
        font-size: 1.8rem;
    }

    .swal2-confirm {
        background-color: #9f161a !important;
    }

    .swal-confirm:not([disabled]):hover {
        background-color: #800e13 !important;
    }

    @media (max-width: 850px) {
        .movie__list {
            grid-template-columns: repeat(auto-fit, minmax(170px, 1fr));
        }

        .movie__figure {
            height: 240px;
            width: 160px;
        }

        .movie__items {
            width: 160px;
        }
    }
</style>

<script>
    //redireccionamiento
    function addDetailsLinks() {
        document.querySelectorAll(".movie__img").forEach((img) => {
            img.addEventListener("click", function () {
                const movieId = this.getAttribute("data-id");
                window.location.href = `movie-details/${movieId}`;
            });
        });
    }

    //busqueda de películas
    const originalMovieCards = document.getElementsByClassName(
        "movie__items",
    ) as HTMLCollectionOf<HTMLElement>;

    function searchMovies() {
        const searchInput = document.getElementById(
            "searchInput",
        ) as HTMLInputElement;
        const searchButton = document.getElementById("searchButton");
        const clearSearchButton = document.getElementById("clearSearchButton");

        function performAndHide() {
            performSearch();
            hideNav();
            searchInput.blur();
        }

        searchInput.addEventListener("keydown", function (event) {
            if (event.key === "Enter") {
                performAndHide();
            }
        });

        searchButton.addEventListener("click", function () {
            performAndHide();
        });

        clearSearchButton.addEventListener("click", function () {
            clearSearch();
            hideNav();
        });

        function hideNav() {
            const menuList = document.querySelector(".nav__list");

            menuList.classList.toggle("nav__list--show");
        }

        function performSearch() {
            const searchText = searchInput.value.toLowerCase();

            //Buscador de películas en todos los cines
            const movieContainers =
                document.querySelectorAll(".movies__container");

            movieContainers.forEach(function (container) {
                const movieCards = container.querySelectorAll(
                    ".movie__items",
                ) as NodeListOf<HTMLElement>;

                // Colocar todas las películas para la búsqueda dentro de cada contenedor
                Array.from(movieCards).forEach(function (movieCard) {
                    movieCard.style.display = "flex";
                });

                // De todas las películas, buscar las que no coincidan dentro de cada contenedor
                Array.from(movieCards).forEach(function (movieCard) {
                    const movieTitle = movieCard.querySelector(".movie__title");
                    // Las películas que no coincidan con el título, se dejan de ver
                    if (
                        movieTitle &&
                        !movieTitle.textContent
                            .toLowerCase()
                            .includes(searchText)
                    ) {
                        movieCard.style.display = "none";
                    }
                });
            });

            // Actualizar mensaje por si no hay películas
            notMoviesMessage();
        }

        function clearSearch() {
            //borrar el contenido de la barra de búsqueda
            searchInput.value = "";

            //mostrar todas las películas
            Array.from(originalMovieCards).forEach(function (originalCard) {
                originalCard.style.display = "flex";
            });

            //actualizar mensaje por si no hay películas
            notMoviesMessage();
        }
    }

    function notMoviesMessage() {
        const movieGenresList = document.querySelectorAll(
            ".movie__genres--list",
        ) as NodeListOf<HTMLElement>;

        movieGenresList.forEach(function (movieList) {
            const movieItems = Array.from(
                movieList.querySelectorAll(
                    ".movie__items",
                ) as NodeListOf<HTMLElement>,
            );

            const allItemsHidden = movieItems.every(function (item) {
                return item.style.display === "none";
            });

            const movieMessage = movieList.querySelector(
                ".noMovies__message--item",
            ) as HTMLElement;
            //si movie__list solo tiene el mensaje y no películas o los elementos están escondidos, no hay películas
            if (movieList.children.length === 1 || allItemsHidden) {
                movieList.style.display = "flex";
                movieList.style.alignItems = "center";
                movieList.style.justifyContent = "center";

                movieMessage.style.display = "flex";
            }

            //Si hay películas, reestablecer el formato de movieList y esconder el mensaje
            else {
                movieList.style.display = "flex";
                movieList.style.alignItems = "center";
                movieList.style.justifyContent = "left";
                movieMessage.style.display = "none";
            }
        });

        const moviesList = document.querySelectorAll(
            ".movie__list",
        ) as NodeListOf<HTMLElement>;

        moviesList.forEach(function (movieList) {
            const movieItems = Array.from(
                movieList.querySelectorAll(
                    ".movie__items",
                ) as NodeListOf<HTMLElement>,
            );

            const allItemsHidden = movieItems.every(function (item) {
                return item.style.display === "none";
            });

            const movieMessage = movieList.querySelector(
                ".noMovies__message--item",
            ) as HTMLElement;
            //si movie__list solo tiene el mensaje y no películas o los elementos están escondidos, no hay películas
            if (movieList.children.length === 1 || allItemsHidden) {
                movieList.style.display = "flex";
                movieList.style.alignItems = "center";
                movieList.style.justifyContent = "center";

                movieMessage.style.display = "flex";
            }

            //Si hay películas, reestablecer el formato de movieList y esconder el mensaje
            else {
                movieList.style.display = "grid";
                movieList.style.justifyContent = "center";
                movieList.style.alignItems = "center";
                movieMessage.style.display = "none";
            }
        });
    }

    //Activar el nav en pantallas pequeñas
    function navResponsive() {
        const menu = document.querySelector(".nav__menu");
        const menuList = document.querySelector(".nav__list");
        const links = document.querySelectorAll(".nav__link");

        menu.addEventListener("click", function () {
            menuList.classList.toggle("nav__list--show");
        });

        links.forEach(function (link) {
            link.addEventListener("click", function () {
                menuList.classList.remove("nav__list--show");
            });
        });
    }

    //Desplazamiento del nav
    function navScroll() {
        const navLinks = document.querySelectorAll(".nav__scroll");

        // Darle función de desplazamiento a cada link
        navLinks.forEach((link) => {
            link.addEventListener("click", function (event) {
                event.preventDefault();

                const targetClass = this.getAttribute("href").substring(1);
                const targetElement = document.querySelector(
                    `.${targetClass}`,
                ) as HTMLElement;

                if (targetElement) {
                    const menuList = document.querySelector(".nav__list");
                    const links = document.querySelectorAll(".nav__link");

                    menuList.classList.toggle("nav__list--show");

                    links.forEach(function () {
                        menuList.classList.remove("nav__list--show");
                    });

                    const headerHeight = 110;
                    const scrollToPosition =
                        targetElement.offsetTop - headerHeight;

                    window.scrollTo({
                        top: scrollToPosition,
                        behavior: "smooth",
                    });
                }
            });
        });
    }

    function initialize() {
        addDetailsLinks();
        searchMovies();
        notMoviesMessage();
        navResponsive();
        navScroll();
    }

    document.addEventListener("DOMContentLoaded", function () {
        initialize();
    });
</script>
